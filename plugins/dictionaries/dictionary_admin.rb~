# encoding: utf-8

def _save(m)
  if $admins.member?(m.nick)
		dict = m.args[:text]
		if not dict
			m.reply "format: !_save <dict>"
		else
			if not $dictionaries.member?( dict )
				m.reply "no hay dicitonario: #{dict}"
			elsif $dictionaries[ dict ].to_s.length > 1000000000 # ~200MB
				m.reply "dictionario #{dict} es demasiado tamañado para gardarse"
			elsif %x{ du -sh dictionaries }.split("\t")[0] =~ /G/
				m.reply "carpeta de gardarse está llena. no puedo completirlo."
			else
				Conf.marshal("dictionaries/#{dict}", $dictionaries[ dict ])
			end
		end  
	end
end
$irc.plugin("_save :text") do |m|
	_save(m)
end
$irc.plugin("_guardar :text") do |m|
	_save(m)
end

def _load(m)
  if $admins.member?(m.nick)
		dict = m.args[:text]
		if not dict
			m.reply "format: !_load <dict>"
		else
			if not File.exists?( "dictionaries/#{dict}" )
				m.reply "no hay dicitonario: #{dict}"
			elsif $dictionaries.member?( dict )
				m.reply "ya hay un dictionario llamado: #{dict}. usa !_recargar"
			else
				$dictionaries[ dict ] = Conf.marshal( "dictionaries/#{dict}" )
			end
		end  
	end
end
$irc.plugin("_load :text") do |m|
	_load(m)
end
$irc.plugin("_cargar :text") do |m|
	_load(m)
end

def _reload(m)
  if $admins.member?(m.nick)
		dict = m.args[:text]
		if not dict
			m.reply "format: !_reload <dict>"
		else
			if not File.exists?( "dictionaries/#{dict}" )
				m.reply "no hay dicitonario: #{dict}"
			else
				$dictionaries[ dict ] = Conf.marshale( "dictionaries/#{dict}" )
			end
		end  
	end
end
$irc.plugin("_reload :text") do |m|
	_reload(m)
end
$irc.plugin("_recargar :text") do |m|
	_reload(m)
end


def _open(m)
  if $admins.member?(m.nick)
			dict = m.args[:text]
		if not dict
			m.reply "format: !_open <dict>"
		else
			$closed = $closed - [dict]
		end
	end
end
$irc.plugin("_open :text") do |m|
	_open(m)
end
$irc.plugin("_abrir :text") do |m|
	_open(m)
end

def _close(m)
  if $admins.member?(m.nick)
			dict = m.args[:text]
		if not dict
			m.reply "format: !_close <dict>"
		else
			$closed = ($closed + [dict]).uniq
		end
	end
end
$irc.plugin("_close :text") do |m|
	_close(m)
end
$irc.plugin("_cerrar :text") do |m|
	_close(m)
end
